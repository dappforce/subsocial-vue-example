<template>
  <section class="edit-post-container">
    <v-card>
      <ValidationObserver ref="form" v-slot="{ handleSubmit, handleReset }">
        <form @submit.prevent="handleSubmit(submit)" @reset.prevent="handleReset(clear)">
          <h2 class="edit-post-title">
            {{ isEdit ? $t('forms.titles.editPost') : $t('forms.titles.newPost') }}
          </h2>

          <v-tabs
            v-if="!isSharedPost"
            v-model="tab"
            background-color="transparent"
            grow
          >
            <v-tabs-slider class="slider-color" />

            <v-tab
              v-for="item in items"
              :key="item"
              :href="'#' + item"
            >
              {{ item }}
            </v-tab>
          </v-tabs>

          <SpacesDropdown :is-edit="isEdit" :space-id="getSpaceId" @selectedSpace="updateSpaceID" />

          <v-tabs-items v-if="!isSharedPost" v-model="tab">
            <v-tab-item
              :key="items[0]"
              :value="items[0]"
            >
              <ImageLoader :avatar="image" :type="'square'" @avatar="updateImageCID" />
            </v-tab-item>

            <v-tab-item
              :key="items[1]"
              :value="items[1]"
            >
              <div class="form-row youtube-container">
                <ValidationProvider v-slot="{ errors }" name="Video URL" :rules="!isArticleTab ? 'required' : ''">
                  <v-text-field
                    v-model="videoUrl"
                    :hide-details="!isArticleTab ? 'auto' : true"
                    :messages="errors[0]"
                    outlined
                    :label="(!isArticleTab ? '* ' : '') + $t('forms.placeholder.videoUrl')"
                  />
                </ValidationProvider>
                <client-only>
                  <Youtube v-if="videoUrl" :link="videoUrl" />
                </client-only>
              </div>
            </v-tab-item>
          </v-tabs-items>
          <div class="form-container">
            <div v-if="!isSharedPost" class="form-row">
              <v-text-field
                v-model="postName"
                hide-details="auto"
                outlined
                :label="$t('forms.placeholder.postTitle')"
              />
            </div>
            <div class="form-row description-row">
              <ValidationProvider v-slot="{ errors }" name="Description" :rules="isArticleTab ? 'required|min:3' : ''">
                <mde-editor
                  :v-validate="description"
                  :show-editor="true"
                  :text="description"
                  :name="$t('forms.fieldName.description')"
                  :placeholder="(isArticleTab ? '* ' : '') + $t('forms.placeholder.postBody')"
                  :height="'200px'"
                  @contentUpdate="updateDescription"
                />
                <v-textarea
                  v-model="description"
                  class="hidden-textarea"
                  :messages="errors[0]"
                />
              </ValidationProvider>
            </div>
            <div v-if="!isSharedPost" class="form-row">
              <v-combobox
                v-model="selectTags"
                hide-details="auto"
                multiple
                outlined
                :label="$t('forms.fieldName.tags')"
                append-icon
                chips
                deletable-chips
                class="tag-input"
                :search-input.sync="search"
                :placeholder="$t('forms.placeholder.tags')"
                @keyup.tab="updateTags"
                @paste="updateTags"
              />
            </div>
            <div v-if="isSharedPost" class="form-row">
              <PostListItem v-if="sharedPost" :post-item-data="sharedPost" :current-user-id="null" :is-shared-post="true" />
            </div>
          </div>
          <div class="button-wp">
            <v-btn class="button-third-color" @click="clear">
              {{ isEdit ? $t('buttons.cancel') : $t('buttons.resetForm') }}
            </v-btn>
            <v-btn class="button-main-color" @click="submit">
              {{ isEdit ? $t('buttons.save') : $t('buttons.createPost') }}
            </v-btn>
          </div>
        </form>
      </ValidationObserver>
    </v-card>
  </section>
</template>

<style lang="scss">
.edit-post-container {
  max-width: 628px;
  margin:$space_large auto 0;
  min-height: 60vh;
  padding-bottom: $space_normal;

  .edit-post-title {
    text-transform: capitalize;
    font-size: $font_large;
  }

  .v-card {
    padding: $space_huge $space_big $space_big;

    .v-tabs {
      border-bottom: 1px solid $line_outline_gray;

      .slider-color {
        color: $slider_color;
      }
    }

    .v-tabs-items {
      background: $tab_bg_white;
      padding-bottom: 0 !important;
    }
  }

  h2 {
    margin: 0;
  }

  .form-row {
    width: 100%;
    margin-bottom: $space_big;

    .CodeMirror-placeholder {
      font-size: 16px;
      color: $text_color_dark_gray;
      opacity: 1;
    }

    &.description-row {
      position: relative;
    }

    .editor-toolbar, .CodeMirror {
      border-color: $border_outline_gray;
    }

    .v-text-field--outlined fieldset {
      border-color: $input_outline_gray;
    }

    .v-text-field--outlined.v-input--is-focused fieldset, .v-text-field--outlined.v-input--has-state fieldset {
      border-width: 1px;
      border-color: $text_color_normal;
    }

    .v-text-field__details {
      position: absolute;
      bottom: -20px;
      left: 0;
      padding: 0;

      .v-messages__message {
        font-size: $font_extra_small;
        color: $text_color_red;
      }
    }
  }

  .youtube-container {
    margin-top: 0;
  }

  .v-chip {
    &__content {
      color: $text_color_normal;
    }
  }

  .hidden-textarea {
    padding: 0 !important;
    textarea, .v-input__slot {
      display: none!important;
      visibility: hidden;
    }
  }

  .button-wp {
    display: flex;
    justify-content: flex-end;
    width: 100%;
    gap: $space_normal;
    margin-top: 5px;

    .button-main-color {
      background-color: $button_bg_primary;
    }

    .button-third-color {
      background-color: $button_bg_white
    }

    button {
      min-width: 110px !important;
      font-size: $font_normal;
      border: 1px solid $button_outline_gray !important;
      border-radius: $border_small;
      box-shadow: none;
      text-transform: capitalize;

      &:last-child {
        border: none;
        color: $text_color_white;
      }
    }

    @media (max-width: 768px) {
      & {
        justify-content: space-between;
      }
    }
  }
}
</style>

<script lang="ts">
import { Component, Prop, Watch } from 'vue-property-decorator'
import { extend, ValidationObserver, ValidationProvider } from 'vee-validate'
import { required, min } from 'vee-validate/dist/rules'
import { SubmittableResult } from '@polkadot/api'
import { CommonContent, IpfsCid } from '@subsocial/types'
import { createPostSlug } from '@subsocial/utils'
import sanitizeHtml from 'sanitize-html'
import { PostListItemData } from '~/models/post/post-list-item.model'
import TransactionButton from '~/components/abstract/TransactionButton.vue'
import { METHODS, PALLETS } from '~/constants/query'
import TransactionService from '~/services/transaction.service'
import { getNewIdFromEvent } from '~/utils/utils'
import { SpaceListItemData } from '~/models/space/space-list-item.model'
import StorageService from '~/services/storage.service'
import SpacesDropdown from '~/components/space/SpacesDropdown.vue'

extend('required', required)
extend('min', min)
extend('required', {
  ...required,
  message: 'This field is required'
})

const storageService = new StorageService()
const transactionService = new TransactionService()

@Component({
  components: { SpacesDropdown, ValidationProvider, ValidationObserver }
})
export default class PostEdit extends TransactionButton {
  $refs!: {
    form: InstanceType<typeof ValidationObserver>;
  }

  @Prop({
    type: Boolean,
    default: false
  }) isEdit!: boolean

  @Prop({
    type: Object
  }) postItem!: PostListItemData

  post: PostListItemData | null = null
  tab: string | null = null
  items: string[] = [this.$t('tabs.article') as string, this.$t('tabs.video') as string]
  postName: string = ''
  description: string = ''
  image: string = ''
  selectTags: string[] = []
  search: string = ''
  videoUrl: string = ''
  spaceId: string = ''
  cid: IpfsCid | undefined
  sharedPost: PostListItemData | null = null

  @Watch('postItem')
  postItemHandler (newVal: any, OldVal: any) {
    if (newVal !== OldVal) {
      this.post = newVal
      this.insertDataInForm()
    }
  }

  created () {
    if (this.isEdit) {
      this.insertDataInForm()

      if (this.postItem.isSharedPost) {
        if (this.$store.getters['posts/getPostInfo'](this.postItem?.sharedPostId)) {
          this.sharedPost = this.$store.getters['posts/getPostInfo'](this.postItem?.sharedPostId)
        } else {
          this.$store.dispatch('posts/getPostById', this.postItem?.sharedPostId).then(() => {
            this.sharedPost = this.$store.getters['posts/getPostInfo'](this.postItem?.sharedPostId)
          })
        }
      }
    }
  }

  insertDataInForm () {
    this.postName = this.postItem.title
    this.description = this.postItem.body
    this.selectTags = this.postItem.tags
    this.image = this.postItem.imageUrl
    this.videoUrl = this.postItem.link || ''
  }

  updateTags () {
    this.$nextTick(() => {
      if (this.search) { this.selectTags.push(...this.search.split(',')) }
      this.$nextTick(() => {
        this.search = ''
      })
    })
  }

  submit () {
    this.$refs.form.validate().then((result) => {
      if (result) {
        this.OnCreateOrUpdatePost()
      }
    })
  }

  clear () {
    this.$refs.form.reset()
    if (this.isEdit) {
      this.insertDataInForm()
    } else {
      this.postName = ''
      this.description = ''
      this.videoUrl = ''
      this.selectTags = []
      this.image = ''
    }
  }

  get isArticleTab (): boolean {
    return this.tab === this.items[0]
  }

  get getSpaceId (): string | undefined {
    if (typeof window !== 'undefined') {
      const spaceId = !this.isEdit ? storageService.getCurrentSpaceId() : ''
      return this.postItem ? this.postItem.spaceId : spaceId
    }
  }

  updateDescription (content: string): void {
    this.description = content
  }

  updateImageCID (cid: string): void {
    this.image = cid
  }

  updateSpaceID (id: string): void {
    this.spaceId = id
  }

  onFailed (): void {
    if (this.cid) {
      transactionService.removeIpfsContent(this.cid).catch(err => new Error(err))
    }
  }

  onSuccess (result: SubmittableResult): void {
    if (this.isEdit && this.cid !== this.post?.contentId) {
      transactionService.removeIpfsContent(this.post?.contentId || '').catch(err => new Error(err))
    }
    const id = this.postItem?.id || getNewIdFromEvent(result)?.toString()
    if (id) {
      this.goToPostPage(id)
    }
  }

  validate (): boolean {
    return true
  }

  async goToPostPage (id: string) {
    const space: SpaceListItemData = await this.$store.getters['space/getSpaceWithContent'](this.spaceId)
    const slug = createPostSlug(id, { title: this.postName, body: this.description })
    if (!this.isEdit) {
      storageService.setCurrentSpaceId(space.struct.id)
    }
    await this.$store.dispatch('posts/getSuggestedPostIds')
    await this.$store.dispatch('posts/getPostById', id).then(() => {
      this.$router.push(this.$nuxt.localePath('/' + (space.struct?.handle || space.struct.id) + '/' + slug))
    })
  }

  async OnCreateOrUpdatePost () {
    const pallet = PALLETS.posts
    const method = this.isEdit ? METHODS.updatePost : METHODS.createPost

    this.cid = await transactionService.saveIpfsContent({
      title: this.postName,
      image: this.isArticleTab ? this.image : '',
      tags: this.selectTags,
      body: sanitizeHtml(this.description),
      link: this.videoUrl || undefined
    } as CommonContent)

    if (!this.cid) { return }

    const params = this.isEdit
      ? [this.postItem?.id, { spaceId: null, content: { IPFS: this.cid }, hidden: null }]
      : [this.spaceId, { RegularPost: null }, { IPFS: this.cid }]

    await this.initExtrinsic({ pallet, params, method })

    await this.sentTransaction()
  }

  get isSharedPost (): boolean {
    return this.postItem ? this.postItem?.isSharedPost : false
  }
}

</script>
